与仓储交互
-----------------------------
现在我们已经了解了建模的基础知识，可以创建我们的第一个仓储类了。仓储类包含所有标准的 CRUD 操作，以及一些高级功能，如分页、过滤和批量操作。

.. tip:: 本教程的完整代码可以在下面的 :ref:`完整代码 <02-repo-full-code>` 部分找到。

在开始编写代码之前，让我们先看看同步和异步仓储中可用的函数。

.. dropdown:: 仓储中的可用函数

    +---------------------+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    |      函数           |    类别        |                                                                                                                 说明                                                                                                                        |
    +=====================+================+=============================================================================================================================================================================================================================================+
    | ``get``             | 选择数据       | 通过主键选择单条记录。当找不到记录时会抛出异常。                                                                                                                                                                                              |
    +---------------------+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | ``get_one``         | 选择数据       | 根据 ``kwargs`` 参数选择单条记录。当找不到记录时会抛出异常。                                                                                                                                                                                  |
    +---------------------+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | ``get_one_or_none`` | 选择数据       | 根据 ``kwargs`` 参数选择单条记录。当找不到记录时返回 ``None``。                                                                                                                                                                              |
    +---------------------+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | ``list``            | 选择数据       | 根据 ``kwargs`` 参数选择记录列表。可以选择性地通过包含的 ``FilterTypes`` 参数进行过滤。                                                                                                                                                       |
    +---------------------+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | ``list_and_count``  | 选择数据       | 根据 ``kwargs`` 参数选择记录列表。可以选择性地通过包含的 ``FilterTypes`` 参数进行过滤。结果作为包含所选行和记录总数的二元组返回。                                                                                                              |
    +---------------------+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | ``get_or_create``   | 创建数据       | 根据 ``kwargs`` 参数选择单条记录。如果找不到记录，则使用给定的值创建一条新记录。有可选属性可以对提供参数的子集进行过滤并合并更新。                                                                                                             |
    +---------------------+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | ``create``          | 创建数据       | 在数据库中创建新记录。                                                                                                                                                                                                                        |
    +---------------------+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | ``create_many``     | 创建数据       | 在数据库中创建一条或多条记录。                                                                                                                                                                                                                |
    +---------------------+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | ``update``          | 更新数据       | 更新数据库中的现有记录。                                                                                                                                                                                                                      |
    +---------------------+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | ``update_many``     | 更新数据       | 更新数据库中的一条或多条记录。                                                                                                                                                                                                                |
    +---------------------+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | ``upsert``          | 更新数据       | 根据模型对象的主键值是否已填充来更新或插入记录的单个操作。                                                                                                                                                                                     |
    +---------------------+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | ``upsert_many``     | 更新数据       | 根据模型对象的主键值是否已填充来更新或插入多条记录。                                                                                                                                                                                           |
    +---------------------+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | ``remove``          | 删除数据       | 从数据库中删除单条记录。                                                                                                                                                                                                                      |
    +---------------------+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | ``remove_many``     | 删除数据       | 从数据库中删除一条或多条记录。                                                                                                                                                                                                                |
    +---------------------+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

.. note::

    - 所有三个批量 DML 操作都将利用特定于数据库方言的增强功能，以尽可能高效。除了使用高效的批量插入绑定外，
      仓储还将在可能的情况下选择性地利用多行 ``RETURNING`` 支持。仓储将自动从 SQLAlchemy 驱动程序检测此支持，
      因此无需额外交互即可启用此功能。

    - SQL 引擎通常对可以附加到 `IN` 子句中的元素数量有限制。仓储操作将自动将超过此限制的列表分解为
      多个查询，这些查询在返回前会连接在一起。您无需在自己的代码中考虑这一点。

在以下示例中，我们将介绍在应用程序中使用仓储的几种方法。

模型仓储
^^^^^^^^^^^^^^^^

这里我们导入 :class:`SQLAlchemyAsyncRepository <advanced_alchemy.repository.SQLAlchemyAsyncRepository>` 
类并创建一个 ``AuthorRepository`` 仓储类。这就是包含所有集成仓储功能所需的全部内容。

.. literalinclude:: /examples/sqla/sqlalchemy_repository_crud.py
    :language: python
    :caption: ``app.py``
    :lines: 14, 7-30
    :linenos:

仓储上下文管理器
^^^^^^^^^^^^^^^^^^

由于我们将在 Litestar 应用程序之外使用仓储，我们将创建一个简单的上下文管理器来自动处理 Author 仓储的创建（和清理）。

``repository_factory`` 方法将为我们执行以下操作：
    - 从 SQLAlchemy 配置自动创建新的数据库会话。
    - 在发生任何异常时回滚会话。
    - 在函数调用完成后自动提交。

.. literalinclude:: /examples/sqla/sqlalchemy_repository_crud.py
    :language: python
    :caption: ``app.py``
    :lines: 39-47
    :linenos:


创建、更新和删除数据
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

为了说明操作数据库中数据的几种方法，我们将演示各种 CRUD 操作：

创建数据：这是一个简单的插入操作，用于填充我们的新 Author 表：

    .. literalinclude:: /examples/sqla/sqlalchemy_repository_crud.py
        :language: python
        :caption: ``app.py``
        :lines: 52-61
        :linenos:

更新数据：``update`` 方法将确保对模型对象所做的任何更新都在数据库上执行：

    .. literalinclude:: /examples/sqla/sqlalchemy_repository_crud.py
        :language: python
        :caption: ``app.py``
        :lines: 64-68
        :linenos:

删除数据：``remove`` 方法接受要删除的行的主键：

    .. literalinclude:: /examples/sqla/sqlalchemy_repository_crud.py
        :language: python
        :caption: ``app.py``
        :lines: 71-75
        :linenos:

现在我们已经了解了如何执行单行操作，让我们看看可以使用的批量方法。


批量数据操作
---------------------------------
在本节中，我们将深入探讨仓储类处理批量数据操作的强大功能。我们的示例说明了如何高效地管理数据库中的数据。
具体来说，我们将使用一个包含美国州及其缩写信息的 JSON 文件。

以下是我们将要介绍的内容：

装载固件数据
^^^^^^^^^^^^^^^^^^^^

我们将介绍一种加载固件数据的方法。固件数据是填充数据库并帮助在真实条件下测试应用程序行为的示例数据。
此模式可以根据您的需要进行扩展和调整。

.. literalinclude:: /examples/sqla/sqlalchemy_repository_bulk_operations.py
    :language: python
    :caption: ``app.py``
    :lines: 1-3, 34-54
    :linenos:

您可以在这里查看 JSON 源文件：

.. dropdown:: 美国州查找 JSON

    您可以下载它：:download:`/examples/sqla/us_state_lookup.json`
    或在下方查看：

    .. literalinclude:: /examples/sqla/us_state_lookup.json
        :language: json
        :caption: ``us_state_lookup.json``


批量插入
^^^^^^^^^^^

我们将使用固件数据来演示批量插入操作。此操作允许您在单个事务中向数据库添加多条记录，
从而在处理较大数据集时提高性能。

.. literalinclude:: /examples/sqla/sqlalchemy_repository_bulk_operations.py
    :language: python
    :caption: ``app.py``
    :lines: 5-11, 13, 14-16, 18-26, 27-33, 55-70
    :linenos:

分页数据选择
^^^^^^^^^^^^^^^^^^^^^^^^

接下来，让我们探讨如何使用分页选择多条记录。此功能对于通过将数据分成可管理的"页面"或子集来处理大量数据非常有用。
``LimitOffset`` 是可以与仓储一起使用的几种过滤器类型之一。

.. literalinclude:: /examples/sqla/sqlalchemy_repository_bulk_operations.py
    :language: python
    :caption: ``app.py``
    :lines: 10, 55-56, 72-74
    :linenos:

批量删除
^^^^^^^^^^^

这里我们演示如何执行批量删除操作。就像批量插入一样，使用批量记录方法删除多条记录比逐行执行更高效。

.. literalinclude:: /examples/sqla/sqlalchemy_repository_bulk_operations.py
    :language: python
    :caption: ``app.py``
    :lines: 76-78
    :linenos:

计数
^^^^^^

最后，我们将演示如何计算数据库中剩余的记录数。

.. literalinclude:: /examples/sqla/sqlalchemy_repository_bulk_operations.py
    :language: python
    :caption: ``app.py``
    :lines: 80-82
    :linenos:

现在我们已经演示了如何在 Litestar 应用程序之外与仓储对象交互，我们的下一个示例将使用依赖注入
将此功能添加到 :class:`~litestar.controller.Controller` 中！

.. _02-repo-full-code:

完整代码
---------

.. dropdown:: 完整代码（点击展开）

    .. literalinclude:: /examples/sqla/sqlalchemy_repository_crud.py
        :language: python
        :caption: ``app.py``
        :emphasize-lines: 14, 27-30, 37-55, 61, 64-71, 71-75, 77-79, 81-83
        :linenos:
